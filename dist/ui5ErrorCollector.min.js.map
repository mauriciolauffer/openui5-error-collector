{"version":3,"file":"ui5ErrorCollector.min.js","sources":["../src/ui5ErrorCollector.js"],"sourcesContent":["'use strict';\n\n(function() {\n  if (window.ui5ErrorCollector) return;\n\n  /**\n   * @typedef UI5ErrorLogEvent\n   * @type {object}\n   * @property {string} type - Log event type\n   * @property {string} timestamp - When event was logged\n   * @property {string} uri - Where event was logged\n   * @property {?string} stack - Error stack\n   * @property {string} message - Error message\n   * @property {?string} component - UI5 Log component\n   * @property {number} level - Log level\n   * @property {?number} elapsedTimestamp - Elapsed time since page load\n   * @property {?string} filename - File which triggered the error\n   */\n\n  /**\n   * @typedef UI5ErrorUi5BaseLogEntry\n   * @type {object}\n   * @property {number} timestamp - When event was logged\n   * @property {string} message - Error message\n   * @property {?string} component - UI5 Log component\n   * @property {number} level - Log level\n   */\n\n  /**\n   * @typedef UI5ErrorConfiguration\n   * @type {object}\n   * @property {number} lastSync - Last time sync has occured\n   * @property {string} serverUrl - Server URL\n   * @property {?UI5ErroronSyncHookCallback} onSyncHook - On sync hook\n   */\n\n  /**\n   * Callback provided to replace default sync with backend server\n   *\n   * @callback UI5ErroronSyncHookCallback\n   * @param {string} serverUrl - Server URL\n   * @param {UI5ErrorLogEvent[]} errors - List of captured errors\n   */\n\n  /**\n   * Check whether UI5 library has been loaded\n   */\n  function checkUi5IsLoaded() {\n    if (window.sap && sap.ui && sap.ui.require) {\n      sap.ui.require(['sap/base/Log'], addUI5LogListener);\n      clearInterval(CHECK_UI5_INTERVAL_ID);\n    } else if (Date.now() - START_TIME > 60000) { // Await UI5 for 1 minute max\n      clearInterval(CHECK_UI5_INTERVAL_ID);\n    }\n  }\n\n  /**\n   * Add custom UI5 log listener to capture all UI5 log events\n   *\n   * @param {module:sap/base/Log} Log UI5 Log module\n   */\n  function addUI5LogListener(Log) {\n    const customLogListener = {\n    /**\n     * Handler for sap/base/Log onLogEntry\n     *\n     * @param {UI5ErrorUi5BaseLogEntry} evt - UI5 log event\n     */\n      onLogEntry: function logUi5LogEntry(evt) {\n        logEvents.push(mapUi5LogEntry(evt));\n      }\n    };\n    Log.addLogListener(customLogListener);\n  }\n\n  /**\n   * Map UI5 log events\n   *\n   * @param {UI5ErrorUi5BaseLogEntry} evt - UI5 log event\n   * @returns {UI5ErrorLogEvent} Mapped error, type = 'ui5'\n   */\n  function mapUi5LogEntry(evt) {\n    const err = new Error(evt.message);\n    return Object.assign({}, LOG_TEMPLATE, {\n      type: 'ui5',\n      timestamp: new Date(evt.timestamp || Date.now()).toJSON(),\n      uri: window.location.href,\n      stack: err.stack,\n      message: evt.message,\n      component: evt.component,\n      level: evt.level\n    });\n  }\n\n  /**\n   * Map js error events\n   *\n   * @param {ErrorEvent} evt - Error event\n   * @returns {UI5ErrorLogEvent} Mapped error, type = 'error'\n   */\n  function mapJsLogEntry(evt) {\n    return Object.assign({}, LOG_TEMPLATE, {\n      type: evt.type,\n      timestamp: new Date().toJSON(),\n      uri: window.location.href,\n      stack: evt.error.stack,\n      message: evt.message,\n      elapsedTimestamp: evt.timeStamp,\n      filename: evt.filename,\n      level: 1\n    });\n  }\n\n  /**\n   * Map Promise unhandledrejection events\n   *\n   * @param {PromiseRejectionEvent} evt - Error event\n   * @returns {UI5ErrorLogEvent} Mapped error, type = 'unhandledrejection'\n   */\n  function mapPromiseLogEntry(evt) {\n    return Object.assign({}, LOG_TEMPLATE, {\n      type: evt.type,\n      timestamp: new Date().toJSON(),\n      uri: window.location.href,\n      message: evt.reason,\n      elapsedTimestamp: evt.timeStamp,\n      level: 1\n    });\n  }\n\n  /**\n   * Map Report API error events\n   *\n   * @param {Report} evt - Report API event\n   * @returns {UI5ErrorLogEvent} Mapped error, type = [deprecation, intervention, crash]\n   */\n  function mapReportApiLogEntry(evt) {\n    const body = evt.body || {};\n    return Object.assign({}, LOG_TEMPLATE, {\n      type: evt.type,\n      timestamp: new Date().toJSON(),\n      uri: evt.url,\n      message: body.message || body.reason,\n      component: body.id,\n      level: 1,\n      filename: body.sourceFile\n    });\n  }\n\n  /**\n   * Get all log entries to be synced\n   *\n   * @returns {UI5ErrorLogEvent[]} Log entries\n   */\n  function getLogsToSync() {\n    return logEvents.filter(function(log) {\n      return new Date(log.timestamp) > new Date(CONFIG.lastSync);\n    });\n  }\n\n  /**\n   * Send errors to the server\n   *\n   */\n  function sendLogsToServer() {\n    const logsToSync = getLogsToSync();\n    if (!CONFIG.serverUrl || logsToSync.length === 0) {\n      return;\n    }\n    const payload = JSON.stringify(logsToSync);\n    if (CONFIG.onSyncHook) {\n      CONFIG.onSyncHook(CONFIG.serverUrl, logEvents);\n    } else {\n      navigator.sendBeacon(CONFIG.serverUrl, payload);\n      setLastSync(Date.now());\n      CONFIG.lastSync = Date.now();\n    }\n  }\n\n  /**\n   * Set configuration\n   *\n   * @param {object} opt - Config options\n   * @param {string} opt.serverUrl - Server URL\n   * @param {?UI5ErroronSyncHookCallback} opt.onSyncHook - On sync hook callback\n   */\n  function setConfiguration(opt) {\n    const params = opt || {};\n    CONFIG.serverUrl = params.serverUrl;\n    if (typeof params.onSyncHook === 'function') {\n      CONFIG.onSyncHook = params.onSyncHook;\n    }\n  }\n\n  /**\n   * Set last syncronization itme\n   *\n   * @param {number} timestamp - Last syncronization date time\n   */\n  function setLastSync(timestamp) {\n    CONFIG.lastSync = timestamp;\n  }\n\n  /**\n   * Get all captured errors\n   *\n   * @returns {UI5ErrorLogEvent[]} Captured errors\n   */\n  function getErrors() {\n    return logEvents;\n  }\n\n  /**\n   * Set ReportingObserver to collect and access reports from Reporting API\n   *\n   * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/Reporting_API}\n   */\n  function setReportingObserver() {\n    if (window.ReportingObserver) {\n      const options = {\n        types: ['deprecation', 'intervention', 'crash'],\n        buffered: true\n      };\n      const observer = new ReportingObserver(function(reports) {\n        reports.forEach(function(report) {\n          logEvents.push(mapReportApiLogEntry(report));\n        });\n      }, options);\n      observer.observe();\n    }\n  }\n\n  /**\n   * @type {UI5ErrorLogEvent[]}\n   */\n  const logEvents = [];\n  /**\n   * @type {UI5ErrorConfiguration}\n   */\n  const CONFIG = {\n    lastSync: 0,\n    serverUrl: '',\n    onSyncHook: null\n  };\n  /**\n   * @type {UI5ErrorLogEvent}\n   */\n  const LOG_TEMPLATE = {\n    type: '',\n    timestamp: '',\n    uri: '',\n    stack: null,\n    message: '',\n    component: null,\n    level: 0,\n    elapsedTimestamp: null,\n    filename: null\n  };\n  const START_TIME = Date.now();\n  const CHECK_UI5_INTERVAL_ID = setInterval(checkUi5IsLoaded, 300);\n  checkUi5IsLoaded();\n  setReportingObserver();\n\n  window.addEventListener('error', function logError(evt) {\n    logEvents.push(mapJsLogEntry(evt));\n  });\n  window.addEventListener('unhandledrejection', function logUnhandledRejection(evt) {\n    logEvents.push(mapPromiseLogEntry(evt));\n  });\n  /* window.addEventListener('beforeunload', function onBeforeUnload() {\n    sendLogsToServer();\n  }); */\n  document.addEventListener('visibilitychange', function onVisibilityChange() {\n    if (document.visibilityState === 'hidden') {\n      sendLogsToServer();\n    }\n  });\n\n  window.ui5ErrorCollector = {\n    getErrors: getErrors,\n    setConfiguration: setConfiguration,\n    setLastSync: setLastSync\n  };\n}());\n"],"names":["checkUi5IsLoaded","addUI5LogListener","CHECK_UI5_INTERVAL_ID","START_TIME","Log","customLogListener","evt","logEvents","mapUi5LogEntry","err","LOG_TEMPLATE","mapJsLogEntry","mapPromiseLogEntry","mapReportApiLogEntry","body","getLogsToSync","log","CONFIG","sendLogsToServer","logsToSync","payload","setLastSync","setConfiguration","opt","params","timestamp","getErrors","setReportingObserver","options","reports","report"],"mappings":"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"}